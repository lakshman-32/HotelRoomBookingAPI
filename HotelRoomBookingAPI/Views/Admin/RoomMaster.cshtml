@model List<HotelRoomBookingAPI.Models.Web.Room>
@{
    ViewData["Title"] = "Room Master";
    var buildings = ViewBag.Buildings as List<HotelRoomBookingAPI.Models.Web.BuildingsMaster>;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Room Master</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRoomModal">
            <i class="bi bi-plus-circle"></i> Add Room
        </button>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="table-responsive">
        <table class="table table-striped table-hover shadow-sm table-master-header">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Building Name</th>
                    <th>Floor Name</th>
                    <th>Room No</th>
                    <th>Room Type</th>
                    <th>Capacity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    int i = 0;
                    foreach (var item in Model)
                    {
                        i++;
                        <tr>
                            <td>@i</td>
                            <td>@(item.Building?.Building_Name ?? "N/A")</td>
                            <td>@(item.Floor?.Description ?? (item.Floor?.FloorNumber.ToString() ?? "N/A"))</td>
                            <td>@item.RoomNumber</td>
                             <td>
                                @if (item.RoomType != null)
                                {
                                    @item.RoomType.RoomTypeName
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                             <td>
                                @if (item.RoomType != null)
                                {
                                    @item.RoomType.Capacity
                                }
                                else
                                {
                                    <span class="text-muted">0</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning" 
                                        onclick="openEditModal(@item.RoomId, @item.Building_ID, @item.FloorId, '@item.RoomNumber', @item.RoomTypeId)">
                                    Edit
                                </button>
                                <form asp-action="DeleteRoom" asp-route-id="@item.RoomId" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this room?');">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center">No rooms found.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Add Room Modal -->
<div class="modal fade" id="addRoomModal" tabindex="-1" aria-labelledby="addRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="AddRoom" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRoomModalLabel">Add Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="mb-3">
                        <label for="Building_ID" class="form-label">Building Name</label>
                        <select class="form-select" name="Building_ID" id="add_Building_ID" required onchange="loadFloors(this.value, 'add_FloorId')">
                            <option value="">Select Building</option>
                            @if (buildings != null)
                            {
                                foreach (var b in buildings)
                                {
                                    <option value="@b.Building_ID">@b.Building_Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="FloorId" class="form-label">Floor Name</label>
                        <select class="form-select" name="FloorId" id="add_FloorId" required disabled>
                            <option value="">Select Building First</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="RoomNumber" class="form-label">Room No</label>
                        <input type="text" class="form-control" name="RoomNumber" required>
                    </div>
                    
                    <!-- Assuming RoomTypes are standard 1-4 for Single-Family as per implementation. 
                         Ideally fetched from DB, but for now hardcoded to match the implicit ID logic or fetched via Viewbag if available. 
                         Going with Hardcoded mapped to assumed IDs/Names for simplicity as per prompt requirement "Room Type -> Dropdown Options". -->
                     <div class="mb-3">
                        <label for="RoomTypeId" class="form-label">Room Type</label>
                        <select class="form-select" name="RoomTypeId" id="add_RoomTypeId" required onchange="updateCapacity(this.value, 'add_Capacity')">
                            <!-- We need actual IDs here. Assuming standard seeding: 1:Single, 2:Double, 3:Deluxe, 4:Family -->
                             <option value="">Select Type</option>
                             @if (ViewBag.RoomTypes != null)
                             {
                                 foreach(var rt in (List<HotelRoomBookingAPI.Models.Web.RoomType>)ViewBag.RoomTypes)
                                 {
                                      <option value="@rt.RoomTypeId" data-capacity="@rt.Capacity">@rt.RoomTypeName</option>
                                 }
                             }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="Capacity" class="form-label">Capacity (Read-only)</label>
                        <input type="text" class="form-control" id="add_Capacity" readonly value="0">
                        <!-- We don't send Capacity, it's derived from RoomType -->
                    </div>

                    <!-- Hidden inputs for default values -->
                    <input type="hidden" name="Status" value="Available">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Room Modal -->
<div class="modal fade" id="editRoomModal" tabindex="-1" aria-labelledby="editRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="EditRoom" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="editRoomModalLabel">Edit Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="RoomId" id="edit_RoomId">
                    <input type="hidden" name="Status" value="Available"> <!-- Should keep existing status but for now simplified -->
                    
                    <div class="mb-3">
                        <label for="edit_Building_ID" class="form-label">Building Name</label>
                        <select class="form-select" name="Building_ID" id="edit_Building_ID" required onchange="loadFloors(this.value, 'edit_FloorId')">
                            <option value="">Select Building</option>
                            @if (buildings != null)
                            {
                                foreach (var b in buildings)
                                {
                                    <option value="@b.Building_ID">@b.Building_Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="edit_FloorId" class="form-label">Floor Name</label>
                        <select class="form-select" name="FloorId" id="edit_FloorId" required>
                             <option value="">Select Floor</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="edit_RoomNumber" class="form-label">Room No</label>
                        <input type="text" class="form-control" name="RoomNumber" id="edit_RoomNumber" required>
                    </div>
                    
                     <div class="mb-3">
                        <label for="edit_RoomTypeId" class="form-label">Room Type</label>
                        <select class="form-select" name="RoomTypeId" id="edit_RoomTypeId" required onchange="updateCapacity(this.value, 'edit_Capacity')">
                            <option value="">Select Type</option>
                             @if (ViewBag.RoomTypes != null)
                             {
                                 foreach(var rt in (List<HotelRoomBookingAPI.Models.Web.RoomType>)ViewBag.RoomTypes)
                                 {
                                      <option value="@rt.RoomTypeId" data-capacity="@rt.Capacity">@rt.RoomTypeName</option>
                                 }
                             }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="edit_Capacity" class="form-label">Capacity (Read-only)</label>
                        <input type="text" class="form-control" id="edit_Capacity" readonly value="0">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function updateCapacity(typeId, targetId) {
        var select = document.querySelector(`select[name="RoomTypeId"] option[value="${typeId}"]`);
        // We need to look at specific select element's options
        // But since we have multiple selects, we should look relative to event or simple ID lookup
        // Ideally pass element, but value is simpler. Let's find the option in the correct select.
        
        var cap = 0;
        // Search in both selects
        var options = document.querySelectorAll('option');
        options.forEach(opt => {
            if(opt.value == typeId && opt.dataset.capacity) {
                cap = opt.dataset.capacity;
            }
        });
        
        document.getElementById(targetId).value = cap;
    }

    function loadFloors(buildingId, targetSelectId, selectedFloorId = null) {
        var floorSelect = document.getElementById(targetSelectId);
        floorSelect.innerHTML = '<option value="">Loading...</option>';
        floorSelect.disabled = true;

        if (!buildingId) {
            floorSelect.innerHTML = '<option value="">Select Building First</option>';
            return;
        }

        fetch('/Admin/GetFloorsByBuilding?buildingId=' + buildingId)
            .then(response => response.json())
            .then(data => {
                floorSelect.innerHTML = '<option value="">Select Floor</option>';
                data.forEach(floor => {
                    var option = document.createElement('option');
                    option.value = floor.floorId;
                    option.text = floor.description + " (" + floor.floorNumber + ")";
                    if (selectedFloorId && floor.floorId == selectedFloorId) {
                        option.selected = true;
                    }
                    floorSelect.appendChild(option);
                });
                floorSelect.disabled = false;
            })
            .catch(error => {
                console.error('Error fetching floors:', error);
                floorSelect.innerHTML = '<option value="">Error loading floors</option>';
            });
    }

    function openEditModal(roomId, buildingId, floorId, roomNo, roomTypeId) {
        document.getElementById('edit_RoomId').value = roomId;
        document.getElementById('edit_Building_ID').value = buildingId;
        document.getElementById('edit_RoomNumber').value = roomNo;
        document.getElementById('edit_RoomTypeId').value = roomTypeId;
        
        // Trigger capacity update
        updateCapacity(roomTypeId, 'edit_Capacity');
        
        // Trigger floor load and set selected
        loadFloors(buildingId, 'edit_FloorId', floorId);
        
        var myModal = new bootstrap.Modal(document.getElementById('editRoomModal'));
        myModal.show();
    }
</script>


